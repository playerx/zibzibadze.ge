<html>

<head>
  <script src="https://balkangraph.com/js/latest/OrgChart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/3.0.0/fetch.min.js"></script>
</head>

<body>
  <div id="tree"></div>
  <script>
    const data = {
      name: 'King George VI',
      imageUrl: '',
      rels: [
        {
          name: 'Queen Elizabeth',
          imageUrl: '',
          children: [
            {
              name: 'Queen Elizabeth II',
              imageUrl: '',
              rels: [
                {
                  name: 'Someone',
                  imageUrl: '',
                  children: [
                    {
                      name: 'Prince Philip',
                      imageUrl: '',
                    },
                    {
                      name: 'Princess Margaret',
                      imageUrl: '',
                    }
                  ]
                },
              ],
            },
          ],
        },
      ],
    }

    window.onload = function () {

      // Prepare templates
      OrgChart.templates.family_template_1 = Object.assign({}, OrgChart.templates.ana);
      OrgChart.templates.family_template_1.size = [200, 140];
      OrgChart.templates.family_template_1.plus = "";
      OrgChart.templates.family_template_1.minus = "";
      OrgChart.templates.family_template_1.node = '';
      OrgChart.templates.family_template_1.rippleRadius = 45;
      OrgChart.templates.family_template_1.name_1 = '<text class="name_1" style="font-size: 12px;" fill="#000000" x="100" y="105" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.name_2 = '<text class="name_2" style="font-size: 12px;" fill="#000000" x="235" y="105" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.name_3 = '<text class="name_3" style="font-size: 12px;" fill="#000000" x="370" y="105" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.name_4 = '<text class="name_4" style="font-size: 12px;" fill="#000000" x="370" y="105" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.title_1 = '<text class="title_1" style="font-size: 12px;" fill="#aeaeae" x="100" y="120" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.title_2 = '<text class="title_2" style="font-size: 12px;" fill="#aeaeae" x="235" y="120" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.title_3 = '<text class="title_3" style="font-size: 12px;" fill="#aeaeae" x="370" y="120" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.title_4 = '<text class="title_4" style="font-size: 12px;" fill="#aeaeae" x="370" y="120" text-anchor="middle">{val}</text>';
      OrgChart.templates.family_template_1.img_0 = '<clipPath id="{randId}"><circle cx="100" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#039BE5" cx="100" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="60" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_1.linkAdjuster =
        {
          fromX: 0,
          fromY: 0,
          toX: 0,
          toY: -95,
        };

      OrgChart.templates.family_template_2 = Object.assign({}, OrgChart.templates.family_template_1);
      OrgChart.templates.family_template_2.size = [335, 140];
      OrgChart.templates.family_template_2.node = '<line x1="145" x2="190" y1="45" y2="45" stroke-width="1" stroke="#000000"></line>';
      OrgChart.templates.family_template_2.img_0 = '<clipPath id="{randId}"><circle cx="100" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#039BE5" cx="100" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="60" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_2.img_1 = '<clipPath id="{randId}"><circle cx="235" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#aeaeae" cx="235" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="195" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_2.linkAdjuster =
        {
          fromX: -65,
          fromY: 0,
          toX: 0,
          toY: -95
        };


      OrgChart.templates.family_template_3 = Object.assign({}, OrgChart.templates.family_template_2);
      OrgChart.templates.family_template_3.size = [470, 140];
      OrgChart.templates.family_template_3.node = '<line x1="145" x2="190" y1="45" y2="45" stroke-width="1" stroke="#000000"></line><line x1="280" x2="325" y1="45" y2="45" stroke-width="1" stroke="#000000"></line>';
      OrgChart.templates.family_template_3.img_0 = '<clipPath id="{randId}"><circle cx="100" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#aeaeae" cx="100" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="60" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_3.img_1 = '<clipPath id="{randId}"><circle cx="235" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#039BE5" cx="235" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="195" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_3.img_2 = '<clipPath id="{randId}"><circle cx="370" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#aeaeae" cx="370" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="330" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_3.linkAdjuster =
        {
          fromX: 0,
          fromY: 0,
          toX: 0,
          toY: -95
        };


      OrgChart.templates.family_template_4 = Object.assign({}, OrgChart.templates.family_template_3);
      OrgChart.templates.family_template_4.size = [605, 140];
      OrgChart.templates.family_template_4.node = '<line x1="145" x2="190" y1="45" y2="45" stroke-width="1" stroke="#000000"></line><line x1="280" x2="325" y1="45" y2="45" stroke-width="1" stroke="#000000"></line><line x1="415" x2="460" y1="45" y2="45" stroke-width="1" stroke="#000000"></line>';
      OrgChart.templates.family_template_4.img_0 = '<clipPath id="{randId}"><circle cx="100" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#aeaeae" cx="100" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="60" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_4.img_1 = '<clipPath id="{randId}"><circle cx="235" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#039BE5" cx="235" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="195" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_4.img_2 = '<clipPath id="{randId}"><circle cx="370" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#aeaeae" cx="370" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="330" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_4.img_3 = '<clipPath id="{randId}"><circle cx="505" cy="45" r="40"></circle></clipPath><circle stroke-width="3" fill="none" stroke="#aeaeae" cx="505" cy="45" r="45"></circle><image preserveAspectRatio="xMidYMid slice" clip-path="url(#{randId})" xlink:href="{val}" x="465" y="5"  width="80" height="80"></image>';
      OrgChart.templates.family_template_4.linkAdjuster =
        {
          fromX: -65,
          fromY: 0,
          toX: 0,
          toY: -95
        };

      const templates = [
        'family_template_1',
        'family_template_2',
        'family_template_3',
        'family_template_4',
      ]


      const mutipliedTemplates = templates.map(x => {

        const to3_1 = `${x}_to_3_1`
        const to3_2 = `${x}_to_3_2`
        const to4_1 = `${x}_to_4_1`
        const to4_2 = `${x}_to_4_2`
        const to4_3 = `${x}_to_4_3`
        const to5_1 = `${x}_to_5_1`
        const to5_2 = `${x}_to_5_2`
        const to5_3 = `${x}_to_5_3`
        const to5_4 = `${x}_to_5_4`

        OrgChart.templates[to3_1] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to3_1].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: -65,
        }

        OrgChart.templates[to3_2] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to3_2].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: 65,
        }

        OrgChart.templates[to4_1] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to4_1].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: -135,
        }

        OrgChart.templates[to4_2] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to4_2].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: 0,
        }

        OrgChart.templates[to4_3] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to4_3].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: 135,
        }

        OrgChart.templates[to5_1] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to5_1].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: -200,
        }

        OrgChart.templates[to5_2] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to5_2].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: -65,
        }

        OrgChart.templates[to5_3] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to5_3].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: 65,
        }

        OrgChart.templates[to5_4] = Object.assign({}, OrgChart.templates[x]);
        OrgChart.templates[to5_4].linkAdjuster = {
          ...OrgChart.templates[x].linkAdjuster,
          toX: 200,
        }

        return [
          to3_1,
          to3_2,
          to4_1,
          to4_2,
          to4_3,
        ]

      }).reduce(concatArray, templates)

      const tags = mutipliedTemplates.map(x => ({
        [x]: { template: x }
      })).reduce((a, b) => ({ ...a, ...b }))

      const nodes2 = [
        { id: "1", tags: ["family_template_2"], name1: "King George VI", name2: "Queen Elizabeth,", title2: "The Queen Mother", img0: "https://balkangraph.com/js/img/f1.png", img1: "https://balkangraph.com/js/img/f2.png" },
        { id: "2", pid: 1, tags: ["family_template_2"], name1: "Prince Philip", name2: "Queen Elizabeth II", title1: "Duke of Edinburgh", img0: "https://balkangraph.com/js/img/f3.png", img1: "https://balkangraph.com/js/img/f5.png" },
        { id: "3", pid: 1, tags: ["family_template_1"], name1: "Princess Margaret", img0: "https://balkangraph.com/js/img/f6.png" },
        { id: "4", pid: 2, tags: ["family_template_4"], name1: "Camila,", name2: "Charles,", name3: "Diana,", title1: "Duchess of Cornwall", title2: "Prince of Wales", title3: "Princess of Wales", img0: "https://balkangraph.com/js/img/f7.png", img1: "https://balkangraph.com/js/img/f8.png", img2: "https://balkangraph.com/js/img/f9.png", img3: "https://balkangraph.com/js/img/f9.png" },
        { id: "5", pid: 2, tags: ["family_template_1"], name1: "Anne", title1: "Princess Royal", img0: "https://balkangraph.com/js/img/f10.png" },
        { id: "6", pid: 2, tags: ["family_template_1"], name1: "Prince Andrew", title1: "Duke of York", img0: "https://balkangraph.com/js/img/f11.png" },
        { id: "7", pid: 2, tags: ["family_template_1"], name1: "Prince Edward", title1: "Earl of Wessex", img0: "https://balkangraph.com/js/img/f12.png" },
        { id: "8", pid: 4, tags: ["family_template_2_to_4_1"], name1: "Catherine,", name2: "Prince William", title1: "Duchess of Cambridge", title2: "Duch of Cambridge", img0: "https://balkangraph.com/js/img/f13.png", img1: "https://balkangraph.com/js/img/f14.png" },
        { id: "9", pid: 4, tags: ["family_template_2_to_4_3"], name1: "Prince Harry", name2: "Meghan Markle", img0: "https://balkangraph.com/js/img/f15.png", img1: "https://balkangraph.com/js/img/f16.png" },
        { id: "10", pid: 8, tags: ["family_template_1"], name1: "Prince George of Cambridge", img0: "https://balkangraph.com/js/img/f17.png" },
        { id: "11", pid: 8, tags: ["family_template_1"], name1: "Prince Charlotte of Cambridge", img0: "https://balkangraph.com/js/img/f18.png" },
        { id: "12", pid: 8, tags: ["family_template_1"], name1: "Prince Louis of Cambridge", img0: "https://balkangraph.com/js/img/f19.png" },
        { id: "13", pid: 8, tags: ["family_template_1"], name1: "Prince Louis of Cambridge", img0: "https://balkangraph.com/js/img/f19.png" }
      ]


      // Transform nodes
      const nodes = mapTree(data)

      console.log(nodes)

      // Create chart
      var chart = new OrgChart(document.getElementById("tree"), {
        tags,
        enableSearch: true,
        nodeMouseClick: OrgChart.action.none,
        mouseScrool: OrgChart.action.zoom,
        nodeBinding: {
          name_1: "name1",
          name_2: "name2",
          name_3: "name3",
          name_4: "name4",
          name_5: "name5",
          title_1: "title1",
          title_2: "title2",
          title_3: "title3",
          title_4: "title4",
          title_5: "title5",
          img_0: "img1",
          img_1: "img2",
          img_2: "img3",
          img_3: "img4",
          img_4: "img5",
        },
        nodes,
      })
    }

    function mapTree(node, parentId = undefined, parentLength = undefined, relId = undefined) {
      const hasRels = node.rels && node.rels.length
      if (!hasRels) {
        return [{
          id: getNextId(),
          pid: parentId,
          tags: ["family_template_1"],
          name1: node.name,
          img1: node.imageUrl,
        }]
      }

      if (node.rels.length > 4) {
        console.error('Currently not supported relations more than 4')
        return null
      }


      const id = getNextId()

      const childItems = node.rels.map(
        (x, i) => (x.children && x.children.length)
          ? x.children.map(c => mapTree(c, id, node.rels.length + 1, i + 1)).reduce(concatArray, [])
          : []
      ).reduce(concatArray, [])

      const tag = `family_template_${node.rels.length + 1}` +
        ((parentLength > 2) ? `_to_${parentLength}_${relId}` : '')


      let people = {}

      switch (node.rels.length) {
        case 1:
          people = {
            name1: node.name,
            img1: node.imageUrl,

            name2: node.rels[0].name,
            img2: node.rels[0].imageUrl,
          }
          break

        case 2:
          people = {
            name1: node.rels[0].name,
            img1: node.rels[0].imageUrl,

            name2: node.name,
            img2: node.imageUrl,

            name3: node.rels[1].name,
            img3: node.rels[1].imageUrl,
          }
          break

        case 3:
          people = {
            name1: node.rels[0].name,
            img1: node.rels[0].imageUrl,

            name2: node.name,
            img2: node.imageUrl,

            name3: node.rels[1].name,
            img3: node.rels[1].imageUrl,

            name4: node.rels[2].name,
            img4: node.rels[2].imageUrl,
          }
          break

        case 4:
          people = {
            name1: node.rels[0].name,
            img1: node.rels[0].imageUrl,

            name2: node.rels[1].name,
            img2: node.rels[1].imageUrl,

            name3: node.name,
            img3: node.imageUrl,

            name4: node.rels[2].name,
            img4: node.rels[2].imageUrl,

            name5: node.rels[3].name,
            img5: node.rels[3].imageUrl,
          }
          break
      }

      return [{
        id,
        pid: parentId,
        tags: [tag],
        ...people,
      }].concat(childItems)
    }

    function concatArray(a, b) {
      return a.concat(b)
    }

    lastId = 1
    function getNextId() {
      return (lastId++).toString()
    }

  </script>
</body>

</html>